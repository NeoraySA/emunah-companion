# Database Instructions

> Domain: `database/` – MySQL on Google Cloud SQL

---

## Responsibilities

- Store all application data: content, users, journals, anchors, media metadata.
- Provide a translation system for multi-language content.
- Support schema migrations (versioned, reversible).
- Provide seed data for development and testing.

---

## Conventions

### General
- **Engine**: MySQL 8.0 on Google Cloud SQL.
- **Instance**: `cartech-mysql` (region: `me-west1-b`).
- **GCP Project**: `cartech-v1`.
- **Database name**: `emunah_companion`.
- **Character set**: `utf8mb4` (full Unicode support for Hebrew + emoji).
- **Collation**: `utf8mb4_unicode_ci`.
- **ORM**: Prisma.

### Naming
| Element           | Convention       | Example                |
| ----------------- | ---------------- | ---------------------- |
| Tables            | snake_case       | `scenario_steps`       |
| Columns           | snake_case       | `created_at`           |
| Primary keys      | `id`             | `id INT AUTO_INCREMENT`|
| Foreign keys      | `<table>_id`     | `scenario_id`          |
| Indexes           | `idx_<table>_<cols>` | `idx_translations_entity` |
| Unique constraints| `uq_<table>_<cols>`  | `uq_translations_composite` |

### Standard Columns

Every table should include:
```sql
created_at  TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
updated_at  TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
```

Tables supporting soft delete should also include:
```sql
deleted_at  TIMESTAMP NULL DEFAULT NULL
```

### File Structure
```
database/
├── prisma/
│   ├── schema.prisma        # Prisma schema (source of truth)
│   ├── migrations/          # Auto-generated by prisma migrate
│   └── seed.ts              # Seed script
├── README.md               # Migration instructions
└── package.json
```

---

## Migration Rules

1. **Schema file is the source of truth**: Edit `schema.prisma`, then run `prisma migrate dev`.
2. **Named migrations**: Prisma auto-generates migration SQL in `migrations/` folder.
3. **Never edit generated migrations**: Create a new migration instead.
4. **Test locally first**: Run migration against local DB before applying to Cloud SQL.
5. **Review generated SQL**: Always check what Prisma generates.

### Migration File Format
```sql
-- UP
CREATE TABLE example (
    id INT AUTO_INCREMENT PRIMARY KEY,
    name VARCHAR(255) NOT NULL,
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- DOWN
DROP TABLE IF EXISTS example;
```

---

## Acceptance Criteria (per migration)

- [ ] Migration runs without error on a clean database.
- [ ] DOWN migration cleanly reverses the UP migration.
- [ ] Foreign keys have proper ON DELETE behavior defined.
- [ ] Indexes exist on frequently queried columns.
- [ ] `utf8mb4` charset used for all text columns.
- [ ] Soft delete columns (`deleted_at`) where applicable.
- [ ] Seed data runs after migration and populates expected defaults.

---

## Testing & Verification

| Type            | Method                                | Command              |
| --------------- | ------------------------------------- | -------------------- |
| Migration test  | Run UP + DOWN on clean local DB       | `npm run migrate`    |
| Seed test       | Run seeds and verify data             | `npm run seed`       |
| Schema check    | Compare live schema to expected       | Manual / diff tool   |
| Query test      | Test complex queries in isolation     | MySQL client / Jest  |

### Checklist
- [ ] All tables created with correct types and constraints.
- [ ] Foreign keys reference correct parent tables.
- [ ] Unique constraints prevent duplicate data.
- [ ] Default values set correctly.
- [ ] Translations table can handle all entity types.
- [ ] Sample data is realistic and covers edge cases.

---

## Security Notes

- Never store passwords in plain text (use bcrypt/argon2 if doing local auth).
- Use parameterized queries in all application code.
- Cloud SQL access: use IAM authentication or strong passwords.
- Restrict DB user permissions (no `DROP DATABASE` in app account).
- Never expose connection strings in client code or logs.

---

## Cloud SQL Connection

```bash
# Local development via Cloud SQL Proxy
cloud-sql-proxy cartech-v1:me-west1-b:cartech-mysql --port=3306 &

# Environment variables
DB_HOST=127.0.0.1
DB_PORT=3306
DB_USER=emunah_app
DB_PASSWORD=<from-secret-manager>
DB_NAME=emunah_companion

# Prisma DATABASE_URL
DATABASE_URL="mysql://emunah_app:<password>@127.0.0.1:3306/emunah_companion"
```
